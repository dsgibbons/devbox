#!/bin/bash

# Run the devtools container with your home directory mounted
# Usage: ./devbox [--build] [--pull] [--platform linux/amd64|linux/arm64]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
IMAGE_NAME="devtools"
GHCR_IMAGE="ghcr.io/dsgibbons/devbox:latest"
FORCE_BUILD=false
PULL_IMAGE=false
PLATFORM=""

while [ $# -gt 0 ]; do
    case $1 in
        --build)
            FORCE_BUILD=true
            shift
            ;;
        --pull)
            PULL_IMAGE=true
            shift
            ;;
        --platform)
            PLATFORM="$2"
            shift 2
            ;;
        *)
            shift
            ;;
    esac
done

# Pull from GHCR if --pull flag is passed
if [ "$PULL_IMAGE" = true ]; then
    echo "Pulling '$GHCR_IMAGE'..."
    docker pull "$GHCR_IMAGE"
    docker tag "$GHCR_IMAGE" "$IMAGE_NAME"
# Build the image if it doesn't exist or --build flag is passed
elif ! docker image inspect "$IMAGE_NAME" &>/dev/null || [ "$FORCE_BUILD" = true ]; then
    # If Dockerfile exists locally, build; otherwise pull from GHCR
    if [ -f "$SCRIPT_DIR/Dockerfile" ]; then
        echo "Building '$IMAGE_NAME'..."
        if [ -n "$PLATFORM" ]; then
            docker build --platform "$PLATFORM" -t "$IMAGE_NAME" "$SCRIPT_DIR"
        else
            docker build -t "$IMAGE_NAME" "$SCRIPT_DIR"
        fi
    else
        echo "Pulling '$GHCR_IMAGE'..."
        docker pull "$GHCR_IMAGE"
        docker tag "$GHCR_IMAGE" "$IMAGE_NAME"
    fi
fi

USER_ID="$(id -u)"
GROUP_ID="$(id -g)"
RUNTIME_DIR="/tmp/runtime-$USER_ID"

# Get docker socket group if it exists
DOCKER_GROUP=""
DOCKER_SOCK_MOUNT=""
if [ -S /var/run/docker.sock ]; then
    DOCKER_SOCK_MOUNT="1"
    # macOS uses stat -f, Linux uses stat -c
    if stat -f %g /var/run/docker.sock >/dev/null 2>&1; then
        DOCKER_GROUP="$(stat -f %g /var/run/docker.sock)"
    else
        DOCKER_GROUP="$(stat -c %g /var/run/docker.sock)"
    fi
fi

# Map terminal types to container-compatible equivalents
# Use xterm-256color as base, COLORTERM=truecolor enables 24-bit color
case "$TERM" in
    xterm-ghostty|*-256color|*-direct) CONTAINER_TERM="xterm-256color" ;;
    *) CONTAINER_TERM="${TERM:-xterm-256color}" ;;
esac

docker run -it --rm \
    -v "$HOME:$HOME" \
    ${DOCKER_SOCK_MOUNT:+-v /var/run/docker.sock:/var/run/docker.sock} \
    -w "$(pwd)" \
    -e HOME="$HOME" \
    -e USER="$USER" \
    -e PATH="/usr/local/bin:/usr/bin:/bin" \
    -e XDG_RUNTIME_DIR="$RUNTIME_DIR" \
    -e HOST_USER="$USER" \
    -e HOST_UID="$USER_ID" \
    -e HOST_GID="$GROUP_ID" \
    -e TERM="$CONTAINER_TERM" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    -e HELIX_RUNTIME="/usr/share/helix-runtime" \
    --user "$USER_ID:$GROUP_ID" \
    ${DOCKER_GROUP:+--group-add "$DOCKER_GROUP"} \
    --hostname devbox \
    --network host \
    "$IMAGE_NAME" fish -c '
        mkdir -p $XDG_RUNTIME_DIR && chmod 700 $XDG_RUNTIME_DIR
        echo "$HOST_USER:x:$HOST_UID:$HOST_GID::$HOME:/usr/bin/fish" >> /etc/passwd
        exec fish
    '
