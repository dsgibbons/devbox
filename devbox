#!/bin/bash

# Run the devtools container with your home directory mounted
# Usage: ./devbox [build|pull] [--platform linux/amd64|linux/arm64]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
IMAGE_NAME="devtools"
GHCR_IMAGE="ghcr.io/dsgibbons/devbox:latest"
FORCE_BUILD=false
PULL_IMAGE=false
PLATFORM=""

# Detect container runtime (docker or podman)
if command -v docker >/dev/null 2>&1; then
    CONTAINER_CMD="docker"
elif command -v podman >/dev/null 2>&1; then
    CONTAINER_CMD="podman"
else
    echo "Error: docker or podman not found" >&2
    exit 1
fi

# SELinux volume label (needed for Podman/RHEL-based systems)
VOLUME_LABEL=""
if command -v getenforce >/dev/null 2>&1 && [ "$(getenforce 2>/dev/null)" != "Disabled" ]; then
    VOLUME_LABEL=":z"
fi

show_help() {
    cat <<EOF
Usage: devbox [command] [options]

Commands:
  (none)    Start the devbox container
  build     Build image from Dockerfile
  pull      Pull pre-built image from GHCR

Options:
  --platform <platform>   Specify platform (linux/amd64 or linux/arm64)
  --help, -h              Show this help message

Examples:
  devbox                              # Start container (pulls if needed)
  devbox build                        # Build from Dockerfile
  devbox pull                         # Pull from GHCR
  devbox build --platform linux/amd64 # Build for specific platform
EOF
    exit 0
}

while [ $# -gt 0 ]; do
    case $1 in
        build|--build)
            FORCE_BUILD=true
            shift
            ;;
        pull|--pull)
            PULL_IMAGE=true
            shift
            ;;
        --platform)
            PLATFORM="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            ;;
        *)
            shift
            ;;
    esac
done

# Pull from GHCR if --pull flag is passed
if [ "$PULL_IMAGE" = true ]; then
    echo "Pulling '$GHCR_IMAGE'..."
    $CONTAINER_CMD pull "$GHCR_IMAGE"
    $CONTAINER_CMD tag "$GHCR_IMAGE" "$IMAGE_NAME"
# Build the image if it doesn't exist or --build flag is passed
elif ! $CONTAINER_CMD image inspect "$IMAGE_NAME" &>/dev/null || [ "$FORCE_BUILD" = true ]; then
    # If Dockerfile exists locally, build; otherwise pull from GHCR
    if [ -f "$SCRIPT_DIR/Dockerfile" ]; then
        echo "Building '$IMAGE_NAME'..."
        if [ -n "$PLATFORM" ]; then
            $CONTAINER_CMD build --platform "$PLATFORM" -t "$IMAGE_NAME" "$SCRIPT_DIR"
        else
            $CONTAINER_CMD build -t "$IMAGE_NAME" "$SCRIPT_DIR"
        fi
    else
        echo "Pulling '$GHCR_IMAGE'..."
        $CONTAINER_CMD pull "$GHCR_IMAGE"
        $CONTAINER_CMD tag "$GHCR_IMAGE" "$IMAGE_NAME"
    fi
fi

USER_ID="$(id -u)"
GROUP_ID="$(id -g)"
RUNTIME_DIR="/tmp/runtime-$USER_ID"

# Get container socket path and group
CONTAINER_SOCK=""
CONTAINER_GROUP=""
if [ -S /var/run/docker.sock ]; then
    CONTAINER_SOCK="/var/run/docker.sock"
elif [ -S "$XDG_RUNTIME_DIR/podman/podman.sock" ]; then
    CONTAINER_SOCK="$XDG_RUNTIME_DIR/podman/podman.sock"
elif [ -S /run/user/$USER_ID/podman/podman.sock ]; then
    CONTAINER_SOCK="/run/user/$USER_ID/podman/podman.sock"
fi

if [ -n "$CONTAINER_SOCK" ]; then
    # macOS uses stat -f, Linux uses stat -c
    if stat -f %g "$CONTAINER_SOCK" >/dev/null 2>&1; then
        CONTAINER_GROUP="$(stat -f %g "$CONTAINER_SOCK")"
    else
        CONTAINER_GROUP="$(stat -c %g "$CONTAINER_SOCK")"
    fi
fi

# Map terminal types to container-compatible equivalents
# Use xterm-256color as base, COLORTERM=truecolor enables 24-bit color
case "$TERM" in
    xterm-ghostty|*-256color|*-direct) CONTAINER_TERM="xterm-256color" ;;
    *) CONTAINER_TERM="${TERM:-xterm-256color}" ;;
esac

$CONTAINER_CMD run -it --rm \
    -v "$HOME:$HOME$VOLUME_LABEL" \
    ${CONTAINER_SOCK:+-v "$CONTAINER_SOCK:/var/run/docker.sock$VOLUME_LABEL"} \
    -w "$(pwd)" \
    -e HOME="$HOME" \
    -e USER="$USER" \
    -e PATH="/usr/local/bin:/usr/bin:/bin" \
    -e XDG_RUNTIME_DIR="$RUNTIME_DIR" \
    -e HOST_USER="$USER" \
    -e HOST_UID="$USER_ID" \
    -e HOST_GID="$GROUP_ID" \
    -e TERM="$CONTAINER_TERM" \
    -e COLORTERM="${COLORTERM:-truecolor}" \
    -e HELIX_RUNTIME="/usr/share/helix-runtime" \
    --user "$USER_ID:$GROUP_ID" \
    ${CONTAINER_GROUP:+--group-add "$CONTAINER_GROUP"} \
    --hostname devbox \
    --network host \
    "$IMAGE_NAME" fish -c '
        mkdir -p $XDG_RUNTIME_DIR && chmod 700 $XDG_RUNTIME_DIR
        echo "$HOST_USER:x:$HOST_UID:$HOST_GID::$HOME:/usr/bin/fish" >> /etc/passwd
        exec fish
    '
